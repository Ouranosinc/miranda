# This file defines the structure of the data on Ouranos' servers
#
# It tries to be define all cases, instead of being flexible, in order to detect potential errors in the facets.
#
# The path-builder function parses this tree from top to bottom, always using the first match.
# Each child of the "datasets" top element may define the following fields:
#
#     with: # Section that decides if we use this element for the given file.
#       - option: < facet >         # A facet and its values to match
#         value: <value or values>  # this can be repeated
#     structure: # The path structure, each element is mapped to a folder level
#       # There are four ways to specify a folder name to use:
#       # Each way can be used recursively in place for < facet >.
#       - < facet >
#       - option: < facet >   # A test on the given facet's value.
#         value: < value >    # Optional. If not given, the test is simple "facet is not empty"
#         is_true: < facet >  # Optional. Facet to use if the test passes. If not given, this level is skipped resulting in a tree of a different depth.
#         else: < facet > # Optional. Facet to use if the test fails. Same consequence as above if not given.
#       - concat:    # The folder name consists in more than one facet, concatenated with a "_" by default.
#         - < facet >
#         - < facet >
#       - text: < value >     # A fixed string
#     filename: # The file name schema, a list of facet names. If a facet is empty, it will be skipped. Elements will be separated by "_".
#               # The special "dates" facet will be replaced by the most concise way found to define the temporal range covered by the file.
---
### Raw data
#
# This structure is meant for raw-like data, usually hourly or daily, used as input for scenario projects.
# It includes bias-adjusted datasets.
datasets:
  - with:
      - option: type
        value: station-obs
    structure:
      - type
      - domain
      - institution
      - concat:
        - source
        - option: version
          is_true: version
      - option: member
        is_true: member
      - frequency
      - variable
    filename: [ variable, frequency, domain, institution, source, version, member, dates ]
  - with:
      - option: type
        value: forecast
    structure:
      - type
      - domain
      - institution
      - source
      - frequency
      - variable
    filename: [ variable, frequency, domain, institution, source, dates ]
  - with:
      - option: type
        value: reconstruction
      - option: processing_level
        value: raw
    structure:
      - type
      - domain
      - institution
      - concat:
        - source
        - option: version
          is_true: version
      - option: member
        is_true: member
      - frequency
      - variable
    filename: [ variable, frequency, domain, institution, source, version, member, dates ]
  - with:
      - option: type
        value: simulation
      - option: processing_level
        value: [ raw, biasadjusted ]
    structure:
      - type
      - processing_level
      - option: bias_adjust_project
        is_true:
          concat:
            - bias_adjust_project
            - option: version
              is_true: version
      - mip_era
      - activity
      - domain
      - institution
      - source
      - option: driving_model
        is_true: driving_model
      - experiment
      - member
      - frequency
      - variable
    filename: [ variable, frequency, bias_adjust_project, version, mip_era, activity, domain, institution, source, driving_model, experiment, member, dates ]
### Derived data
#
# This structure is meant for the output of scenario projects.
# The main differences here are that:
#
#     - domain denotes the zone over which the scenario was computed, not the original source's coverage
#     - processing_level has more possible values, denoting slight variant of the data instead of broad categories.
#     As such, both fields are here much lower in the hierarchy.
derived:
  - with:
    - option: type
      value: simulation
    structure:
      - type
      - option: bias_adjust_project
        is_true:
          concat:
            - bias_adjust_project
            - option: version
              is_true: version
        else:
          text: raw
      - mip_era
      - activity
      - institution
      - source
      - option: driving_model
        is_true: driving_model
      - experiment
      - member
      - domain
      - processing_level
      - frequency
      - variable
    filename: [ variable, frequency, bias_adjust_project, version, mip_era, activity, institution, source, driving_model, experiment, member, domain, processing_level, dates ]
  - with:
      - option: type
        value: reconstruction
    structure:
      - type
      - institution
      - concat:
        - source
        - option: version
          is_true: version
      - option: member
        is_true: member
      - domain
      - processing_level
      - frequency
      - variable
    filename: [ variable, frequency, institution, source, version, member, domain, processing_level, dates ]
